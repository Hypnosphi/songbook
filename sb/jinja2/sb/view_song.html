{% extends "base.html" %}

{% block pagetitle %}{{ song.title }} | {{ super() }}{% endblock %}

{% block content %}

<h1>
  {{ song.title }}
  <sup><span class="text-muted small">
    {%- trans suggested_by=song.suggested_by -%}
      suggested by {{ suggested_by }}
    {%- endtrans -%}
  </span></sup>
</h1>

{% if song.artist %}
  <h3>{{ song.artist }}</h3>
{% endif %}

{% if song.description %}
  <div class="lead">{{ song.description|markdown_safe }}</div>
{% endif %}

<hr>

<div class="row">
  <div class="col-sm-4">
    <ul id="partsinfo">
      {% for part_info in parts %}
        <li {% if part_info.has_joined %}class="joined"{% endif %}>
          <div class="controls">
            <span class="instrument-name">{{ part_info.part.instrument.name }}</span>
            {% if part_info.part.notice %}
              <span class="text-muted">({{ part_info.part.notice }})</span>
            {% endif %}
            <button type="button" class="btn btn-default btn-xs show-join-form not-joined"
              title="{{ _("Join this part") }}"
              data-toggle="collapse" data-target="#join-part-{{ part_info.part.pk }}-form">
              <span class="glyphicon glyphicon-flag"></span>
            </button>
            <button type="button" class="btn btn-default btn-xs show-join-form joined"
              title="{{ _("Change notice or leave this part") }}"
              data-toggle="collapse" data-target="#join-part-{{ part_info.part.pk }}-form">
              <span class="glyphicon glyphicon-flag"></span>
            </button>
            <button type="button" class="btn btn-default btn-xs remove-part"
              title="{{ _("Remove this part") }}"
              data-toggle="collapse" data-target="#remove-part-{{ part_info.part.pk }}-form">
              <span class="glyphicon glyphicon-trash"></span>
            </button>
          </div>

          <div id="remove-part-{{ part_info.part.pk }}-form" class="remove-part-form collapse">
            <form method="post" action="{{ url('sb:remove-song-part', part_info.part.pk) }}"
              class="well well-sm">
              {{ csrf(csrf_token) }}
              <p>{% trans %}This action can not be undone.{% endtrans %}</p>
              <button type="submit" class="btn btn-danger">
                {{ _("Confirm remove") }}
              </button>
            </form>
          </div>

          <div id="join-part-{{ part_info.part.pk }}-form" class="join-form collapse">
            <form class="well well-sm"
              data-join-action="{{ url('sb:join-song-part', part_info.part.pk) }}"
              data-leave-action="{{ url('sb:leave-song-part', part_info.part.pk) }}">
              {{ csrf(csrf_token) }}
              <p>{{ part_info.join_form.notice }}</p>
              <button type="button" class="btn btn-primary join-part">
                {% trans %}Join{% endtrans %}
              </button>
              <button type="button" class="btn btn-success save-changes">
                {% trans %}Save{% endtrans %}
              </button>
              <button type="button" class="btn btn-danger leave-part">
                {% trans %}Leave part{% endtrans %}
              </button>
            </form>
          </div>

          <ul id="part-{{ part_info.part.id }}-performers" class="performers">
            {% for performer in part_info.performers %}
              <li>
                {{- performer.performer -}}
                {% if performer.notice %} <span class="text-muted">({{ performer.notice }}){% endif -%}
              </li>
            {% else %}
              <span class="text-danger">&ndash;</span>
            {% endfor %}
          </ul>
        </li>
      {% endfor %}
    </ul>
    <div>
      <button type="button" class="btn btn-default btn-sm"
        data-toggle="collapse" data-target="#add-a-part">
        {{ _("Add a part") }}
      </button>
      <div id="add-a-part" class="collapse">
        <p>
          <form class="well well-sm" method="post"
            action="{{ url('sb:add-song-part', song.pk) }}">
            {{ csrf(csrf_token) }}
            {{ new_part_form.as_bootstrap_form() }}
            <button type="submit" class="btn btn-primary submit">
              {{ _("Add") }}
            </button>
            <button type="button" class="btn btn-default"
              data-toggle="collapse" data-target="#add-a-part">
              {{ _("Cancel") }}
            </button>
          </form>
        </p>
      </div>
    </div>
  </div>
  <div class="col-sm-8">
    <ul id="links">
      {% for link, link_edit_form in links %}
        <li>
          {% if link.notice %}
            <span class="link-notice">{{ link.notice }}:</span>
            <a href="{{ link.link }}" target="_blank">
              {{- link.link|truncate(60) -}}
            </a>
          {% elif link.link|is_yamusic_link %}
            <span class="link-notice">{{ _("Yandex.Music:") }}</span>
            <a href="{{ link.link }}" target="_blank">
              {{- link.link|truncate(60) -}}
            </a>
          {% elif link.link|is_youtube_link %}
            <span class="link-notice">{{ _("YouTube video:") }}</span>
            <a href="{{ link.link }}" target="_blank">
              {{- link.link|truncate(60) -}}
            </a>
          {% else %}
            <a href="{{ link.link }}" target="_blank" class="link-notice">
              {{- link.link|truncate(60) -}}
            </a>
          {% endif %}

          {% if link.link|is_youtube_link %}
            <button type="button" class="btn btn-default btn-sm"
              data-toggle="collapse" data-target="#youtube-{{ link.pk }}">
              {{ _("show") }}
            </button>
          {% endif %}

          <span class="controls">
            <button type="button" class="btn btn-default btn-xs show-edit-form"
              title="{{ _("Edit link") }}"
              data-toggle="collapse" data-target="#edit-link-{{ link.pk }}-form">
              <span class="glyphicon glyphicon-pencil"></span>
            </button>
            <button type="button" class="btn btn-default btn-xs show-remove-form"
              title="{{ _("Remove this link") }}"
              data-toggle="collapse" data-target="#remove-link-{{ link.pk }}-form">
              <span class="glyphicon glyphicon-trash"></span>
            </button>
          </span>

          <div id="edit-link-{{ link.pk }}-form" class="collapse edit-form">
            <form class="well well-sm" method="post"
              action="{{ url('sb:edit-song-link', link.pk) }}">
              {{ csrf(csrf_token) }}
              {{ link_edit_form.as_bootstrap_form() }}
              <button type="submit" class="btn btn-primary submit">
                {{ _("Save") }}
              </button>
              <button type="button" class="btn btn-default"
                data-toggle="collapse" data-target="#edit-link-{{ link.pk }}-form">
                {{ _("Cancel") }}
              </button>
            </form>
          </div>
          <div id="remove-link-{{ link.pk }}-form" class="collapse remove-form">
            <form method="post" action="{{ url('sb:remove-song-link', link.pk) }}"
              class="well well-sm">
              {{ csrf(csrf_token) }}
              <button type="submit" class="btn btn-danger">
                {{ _("Confirm remove") }}
              </button>
              {% trans %}This action can not be undone.{% endtrans %}
            </form>
          </div>

          {% if link.link|is_yamusic_link %}
            <div class="embedded-player">
              <iframe style="border:none; width: 600px; height: 100px;"
                src="{{ link.link|get_yamusic_embed_link }}"></iframe>
            </div>
          {% elif link.link|is_youtube_link %}
            <div class="embedded-player collapse" id="youtube-{{ link.pk }}">
              <iframe width="600" height="{{ 600 / (1 + 1/3) }}"
                src="{{ link.link|get_youtube_embed_link }}"
                frameborder="0" allowfullscreen></iframe>
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    <div>
      <button type="button" class="btn btn-default btn-sm"
        data-toggle="collapse" data-target="#add-a-link">
        {{ _("Add a link") }}
      </button>
      <div id="add-a-link" class="collapse">
        <p>
          <form class="well well-sm" method="post"
            action="{{ url('sb:add-song-link', song.pk) }}">
            {{ csrf(csrf_token) }}
            {{ new_link_form.as_bootstrap_form() }}
            <button type="submit" class="btn btn-primary submit">
              {{ _("Add") }}
            </button>
            <button type="button" class="btn btn-default"
              data-toggle="collapse" data-target="#add-a-link">
              {{ _("Cancel") }}
            </button>
          </form>
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  ul#links div.embedded-player {
    margin-top: 1em;
  }
  ul#partsinfo,
  ul#links {
    padding: 0;
  }
  ul#partsinfo > li,
  ul#links > li {
    list-style: none;
    padding: 1em 0;
  }
  ul#partsinfo .controls button,
  ul#links .controls button {
    display: none;
    margin: -2px 0;
  }
  ul#partsinfo > li:hover button.not-joined,
  ul#partsinfo > li:hover button.remove-part,
  ul#links > li:hover .controls button {
    display: inline-block;
  }
  ul#partsinfo .instrument-name,
  ul#links .link-notice {
    font-size: 120%;
  }
  ul#partsinfo .join-form > *,
  ul#partsinfo .remove-part-form > * {
    display: inline-block;
  }
  ul#partsinfo button.save-changes,
  ul#partsinfo button.joined,
  ul#partsinfo button.leave-part {
    display: none;
  }
  ul#partsinfo li.joined button.join-part,
  ul#partsinfo li.joined button.not-joined {
    display: none;
  }
  ul#partsinfo li.joined button.save-changes,
  ul#partsinfo li.joined:hover button.joined,
  ul#partsinfo li.joined button.leave-part {
    display: inline-block;
  }
  form.remove-part {
    display: inline;
  }
  ul#partsinfo .controls {
    margin-bottom: 1em;
  }
  ul#links .edit-form,
  ul#links .remove-form {
    margin: 1em 0;
  }
</style>

<script>
  function initPartsInfo() {
    $('#partsinfo button.join-part, #partsinfo button.save-changes').click(function() {
      var joinFormContainer = $(this).parents('li').find('.join-form');
      var joinForm = joinFormContainer.find('> form');
      var partContainer = joinFormContainer.parents('ul#partsinfo > li');
      var data = joinForm.serialize();
      var action = joinForm.data('join-action');
      $.post(action, data, function(result) {
        joinFormContainer
          .collapse('hide')
          .one('hidden.bs.collapse', function() {
            partContainer.addClass('joined');
          });
        var performersContainer = partContainer.find('.performers');
        performersContainer.load(
          window.location.href + ' #' + performersContainer.attr('id') + ' > *'
        );
      });
    });
    $('#partsinfo button.leave-part').click(function() {
      var joinFormContainer = $(this).parents('li').find('.join-form');
      var joinForm = joinFormContainer.find('> form');
      var partContainer = joinFormContainer.parents('ul#partsinfo > li');
      var data = joinForm.serialize();
      var action = joinForm.data('leave-action');
      $.post(action, data, function(result) {
        joinFormContainer
          .collapse('hide')
          .one('hidden.bs.collapse', function() {
            partContainer.removeClass('joined')
          });
        var performersContainer = partContainer.find('.performers');
        performersContainer.load(
          window.location.href + ' #' + performersContainer.attr('id') + ' > *'
        );
      });
    });
    $('#partsinfo .remove-part-form form').on("submit", function(event) {
      event.preventDefault();
      var form = $(this);
      $.post(form.attr('action'), form.serialize(), function(result) {
        form.parents('ul#partsinfo > li').slideUp(function() {
          $(this).remove();
        });
      });
    });
  };

  function initLinks() {
    $('#add-a-link form').on('submit', function(event) {
      event.preventDefault();
      $.post($(this).attr('action'), $(this).serialize(), function(result) {
        $('#links').load(window.location.href + ' #links > *', function() {
          initLinks();
          $('#add-a-link').collapse('hide');
        });
      });
    });

    $('#links .remove-form form').on('submit', function(event) {
      event.preventDefault();
      var form = $(this);
      $.post(form.attr('action'), form.serialize(), function(result) {
        form.parents('ul#links > li').slideUp(function() {
          $(this).remove();
        });
      });
    });

    $('#links .edit-form form').on('submit', function(event) {
      event.preventDefault();
      var form = $(this);
      $.post(form.attr('action'), form.serialize(), function(result) {
        $('#links').load(window.location.href + ' #links > *', function() {
          initLinks();
          form.parents('ul#links .edit-form').collapse('hide');
        });
      });
    });
  };

  $(function() {
    initPartsInfo();
    initLinks();

    var addAPartForm = $('#add-a-part form');

    addAPartForm.on("submit", function(event) {
      event.preventDefault();
      var data = addAPartForm.serialize();
      var action = addAPartForm.attr('action');
      $.post(action, data, function(result) {
        $('#partsinfo').load(window.location.href + ' #partsinfo > *', function() {
          initPartsInfo();
          addAPartForm.parent().collapse('hide');
        });
      });
    });
  });
</script>


{% endblock %}
